/*
 * File: app/view/menu/menuPanelViewController.js
 *
 * This file was generated by Sencha Architect version 3.1.0.
 * http://www.sencha.com/products/architect/
 *
 * This file requires use of the Ext JS 5.0.x library, under independent license.
 * License of Sencha Architect does not include license for Ext JS 5.0.x. For more
 * details see http://www.sencha.com/license or contact license@sencha.com.
 *
 * This file will be auto-generated each and everytime you save your project.
 *
 * Do NOT hand edit this file.
 */

Ext.define('Evcorp.view.contractCar.CreditReportingWinViewController', {
    extend: 'Ext.app.ViewController',
    alias: 'controller.CreditReportingWin',
    initWindow:function(){
    	var win = this.getView();
    	var olPreSaleOrderNo = '';
    	var store = win.getViewModel().getStore('detail');
		if(store!=null){
			store.load({
				params:{businessKey:win.businessKey},
				callback: function(rr, operation, success) {
					if(success){
						olPreSaleOrderNo = rr[0].data.olPreSaleOrderNo;
						var orderListDetailPanel = win.down('orderlistdetails');
						if(orderListDetailPanel!=null){
							var contractCarOrderDetailListStore = orderListDetailPanel.getViewModel().getStore('contractCarOrderDetailListStore');
							if(contractCarOrderDetailListStore!=null)
								contractCarOrderDetailListStore.load({params:{orderNo:win.businessKey}});
							var contractCarOrderPayLogListStore = orderListDetailPanel.getViewModel().getStore('contractCarOrderPayLogListStore');
				    		if(contractCarOrderPayLogListStore!=null)
								contractCarOrderPayLogListStore.load({params:{orderNo: win.businessKey}});
				    		var replaymentPlanListStore = orderListDetailPanel.getViewModel().getStore('replaymentPlanListStore');
				    		if(replaymentPlanListStore!=null)
					    		replaymentPlanListStore.load({params:{orderNo: win.businessKey}});
							var contractCarSuppleAgreementListStore = orderListDetailPanel.getViewModel().getStore('contractCarSuppleAgreementListStore');
							if(contractCarSuppleAgreementListStore!=null){
					    		contractCarSuppleAgreementListStore.load({params:{orderNo:win.businessKey}});
							}
							var businessKey = olPreSaleOrderNo; // 附件业务实体编号：征信材料编号
	        	        	var businessType = 'attachBizEntityType_ZXCL'; // 附件业务实体类型：征信材料代码
	        	        	var businessTypeName = '征信材料'; // 附件业务实体类型名称：征信材料（理论上从字典表去nameCn字段
	        	        	
	        	        	var creditattachmentStore = orderListDetailPanel.getViewModel().getStore('creditattachmentStore');
	    	    			if(creditattachmentStore!=null){
	    	    				creditattachmentStore.load({params:{bizEntityCode:businessKey,bizEntityType:businessType}});
	    	    			}
	    	    			var credittypeStore = orderListDetailPanel.getViewModel().getStore('creditattachmentTypeStore');
	    	    			credittypeStore.load({params:{type:businessType}});
	    	    			
						}
					}
			    }
			});
		}
    },
    onAgreeClick:function(){
    	var win = this.getView();
    	var taskId = win.taskId;
    	var processInstanceId = win.processInstanceId;
    	var businessKey = win.businessKey;
    	var comment = this.lookupReference('commentForm').getForm().getValues().comment;
    	win.mask("请稍等，正在处理中...","x-mask-loading");
    	Ext.Ajax.request({
			url : 'ccOrder/creditApproveAgree',
			params : {
				taskId : taskId,
				processInstanceId : processInstanceId,
				businessKey : businessKey,
				comment : comment
			},
            method: 'POST',	
			success : function(data) {
				win.unmask();
				Ext.Msg.alert("提示",'审核通过成功',function(){
	    			var myActiveTaskGrid = Ext.ComponentQuery.query('#myActiveTaskGrid')[0];
	    			var myActiveTaskStore = myActiveTaskGrid.getStore();
	    			myActiveTaskStore.loadPage(1 ,{"start":0,"limit":20});
	    			var eastPanel = Ext.ComponentQuery.query("#eastPanelId")[0];
	    	        eastPanel.removeAll();
	    			win.close();
	    		});
			}
		});
    },
    onRejectClick:function(){
    	var win = this.getView();
    	var taskId = win.taskId;
    	var processInstanceId = win.processInstanceId;
    	var businessKey = win.businessKey;
    	var comment = this.lookupReference('commentForm').getForm().getValues().comment;
    	if(comment==null||comment==''){
    		Ext.Msg.alert("提示",'请填写审批意见')
    	}else{
    		win.mask("请稍等，正在处理中...","x-mask-loading");
    		Ext.Ajax.request({
    			url : 'ccOrder/creditApproveReject',
    			params : {
    				taskId : taskId,
    				processInstanceId : processInstanceId,
    				businessKey : businessKey,
    				comment : comment
    			},
                method: 'POST',	
    			success : function(data) {
    				win.unmask();
    				Ext.Msg.alert("提示",'审核不通过成功',function(){
    	    			var myActiveTaskGrid = Ext.ComponentQuery.query('#myActiveTaskGrid')[0];
    	    			var myActiveTaskStore = myActiveTaskGrid.getStore();
    	    			myActiveTaskStore.loadPage(1 ,{"start":0,"limit":20});
    	    			var eastPanel = Ext.ComponentQuery.query("#eastPanelId")[0];
		    	        eastPanel.removeAll();
    	    			win.close();
    	    		});
    			}
    		});
    	}
    }
});
