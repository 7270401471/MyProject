/*
 * File: app/view/menu/menuPanelViewController.js
 *
 * This file was generated by Sencha Architect version 3.1.0.
 * http://www.sencha.com/products/architect/
 *
 * This file requires use of the Ext JS 5.0.x library, under independent license.
 * License of Sencha Architect does not include license for Ext JS 5.0.x. For more
 * details see http://www.sencha.com/license or contact license@sencha.com.
 *
 * This file will be auto-generated each and everytime you save your project.
 *
 * Do NOT hand edit this file.
 */

Ext.define('Evcorp.view.orderList.CancelProcessWinViewController', {
    extend: 'Ext.app.ViewController',
    alias: 'controller.CancelProcessWin',
    saveCancelProcessClick : function(){
    	var form = this.lookupReference('cancelProcessForm');
    	var contractCarOrderGrid = Ext.ComponentQuery.query('viewport orderlistpanel #contractCarOrderGrid')[0];
    	var seletedGird = contractCarOrderGrid.getSelectionModel().getSelection();
    	var gridStore = contractCarOrderGrid.getStore();
		var win = this.getView();
		var isValid = form.getForm().isValid();
		var contractCarOrderId = form.getForm().findField('contractCarOrderId').value;
		if (!isValid) {
			Ext.Msg.alert("提示", '请把信息填完整');
			return;
		}
    	Ext.MessageBox.confirm('提示', '确定取消合约车订单?', function(btn) {
			if (btn != 'yes') {
				return;
			}
			form.getForm().submit({
				success : function(form, action) {
					if (action.result.errorMsg) {
						Ext.Msg.alert("提示", action.result.errorMsg);
					} else {
						gridStore.reload({
	    					callback: function(){
	    						var selectRow = gridStore.findRecord('id', contractCarOrderId);
	    						contractCarOrderGrid.getSelectionModel().select(selectRow); // TODO 此代码没有执行成功，下面代码扑救，但是车辆及保险信息、合同信息选项卡内容没有重新加载
	    						var status = Ext.ComponentQuery.query('viewport orderlistpanel #status')[0];
	    				    	status.setValue(selectRow.data.status);
	    				    	var cancelBtn = Ext.ComponentQuery.query('viewport orderlistpanel #cancelContractCarProcessBtn')[0];
	    				    	cancelBtn.setDisabled(true);
	    					}
	    				});
						Ext.Msg.alert("提示", "取消成功！");
						win.close();
					}
					
				},
				failure : function(form, action) {
					Ext.Msg.alert("提示", "系统错误，操作失败");
					win.close();
				}
			})
		});
    },
    
    onCancel:function(){
    	var win = this.getView();
    	win.close();
    }
});
