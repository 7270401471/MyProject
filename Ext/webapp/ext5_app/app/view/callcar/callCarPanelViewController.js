/*
 * File: app/view/role/RoleMangerPanelViewController.js
 *
 * This file was generated by Sencha Architect version 3.1.0.
 * http://www.sencha.com/products/architect/
 *
 * This file requires use of the Ext JS 5.0.x library, under independent license.
 * License of Sencha Architect does not include license for Ext JS 5.0.x. For more
 * details see http://www.sencha.com/license or contact license@sencha.com.
 *
 * This file will be auto-generated each and everytime you save your project.
 *
 * Do NOT hand edit this file.
 */

Ext.define('Evcorp.view.callcar.callCarPanelViewController', {
    extend: 'Ext.app.ViewController',
    alias: 'controller.callCarPanel',
    oncallCarClick : function() {
    	var callCarwin = Ext.create({
    		xtype : 'callCarDolistWin',
    		width : '90%',
    		closeAction : 'destroy'
    	});
    	callCarwin.show();
    },

	callCarOperate:function(e, cell){
			var cellindex=cell.cellIndex;
			if(cellindex==9){
				var window = Ext.create({
					xtype : 'callCarDolistWin',
					width : 900,
					closeAction : 'destroy'
				});
				window.show();
			};

	},
	onProviderSearch : function() {
    	var callCarwin = Ext.create({
    		 xtype : 'providerListWin',
    		//xtype : 'orderlistattachmentwin',
    		width : 600,
    		closeAction : 'destroy'
    	});
    	callCarwin.show();
    },
	
	
	onCreateClaimRule : function() {

		var accModel = new Evcorp.model.CallCarDemand({
					id : -1
				});
		var gridStore = this.getView().getViewModel().getStore('callCarDemandStore');
		gridStore.insert(0,accModel);
	},
	searchClick:function(){
		var callCarDemandSearchForm = this.lookupReference('callCarDemandSearchForm');
        var callCarDemandGrid = this.lookupReference('callCarDemandGrid');
        var extraParams = callCarDemandSearchForm.getForm().getValues();
        var callCarDemandStore = callCarDemandGrid.getStore(); 
        
        callCarDemandStore.on("beforeload", function (callCarDemandStore, operation, eOpts) {
					 Ext.apply(callCarDemandStore.proxy.extraParams, extraParams);
					});
       
        callCarDemandStore.loadPage(1,{"start":0,"limit":20});
        callCarDemandGrid.getSelectionModel().deselectAll();

	},
	onCallCarDemandSelected:function(grid, td, cellIndex, record, tr, rowIndex, e, eOpts){
    	var modify = e.getTarget('.btn-primary');
    	var del = e.getTarget('.btn-danger');
    	if(modify){
    		var win = Ext.create({
        		xtype : 'callCarDolistWin',
        		width : '90%',
        		closeAction : 'destroy'
        	});
    		win.down("form").loadRecord(record);
    		var usageStore = win.getViewModel().getStore('carUsageStore');
    		usageStore.load();
    		var store = win.getViewModel().getStore('callCarDemandDetailStore');
    		store.load({params:{demandId:record.data.id}});
        	win.show();
    	}
    	if(del){
    		var callCarDemandGrid = this.lookupReference('callCarDemandGrid');
    		var callCarDemandStore = callCarDemandGrid.getStore();
    		Ext.Ajax.request({
				url : 'callCar/deleteCallCarDemand',
				params : {
					id : record.data.id
				},
	            method: 'POST',	
				success : function(data) {
					if(data.responseText=='success'){
						callCarDemandStore.loadPage(1 ,{"start":0,"limit":10});
					}
				}
			});
    	}
    },
    onExportClick:function(){
    	var callCarDemandGrid = this.lookupReference('callCarDemandGrid');
    	var sel = callCarDemandGrid.getSelectionModel().getSelection();
    	var ids = [];
    	Ext.each(sel,function(item){
    		ids.push(item.data.id);
		});
    	if(ids.length>0){
    		window.open('callCar/download/callCarDemandFile?ids='+ids);
    	}
    },
    onSubmitClick:function(){
    	var callCarDemandGrid = this.lookupReference('callCarDemandGrid');
    	var callCarDemandStore = callCarDemandGrid.getStore();
    	var sel = callCarDemandGrid.getSelectionModel().getSelection();
    	var ids = [];
    	Ext.each(sel,function(item){
			ids.push(item.data.id);
		});
    	if(ids.length>0){
    		Ext.getBody().mask("请稍等，正在处理中...","x-mask-loading");
    		Ext.Ajax.request({
				url : 'callCar/startCallCarProcess',
				params : {
					ids : ids
				},
	            method: 'POST',	
				success : function(data) {
					if(data.responseText=='success'){
						Ext.getBody().unmask();
						Ext.Msg.alert("提示",'提交成功,CALL车流程已启动',function(){
		        			callCarDemandStore.loadPage(1 ,{"start":0,"limit":10});
		        		});
					}
				}
			});
    	}
    },
    onProviderSearch : function() {
    	var providerWin = Ext.create({
    		xtype : 'providerListWin',
    		width : '60%',
    		height: '60%',
    		closeAction : 'destroy'
    	});
    	providerWin.show();
    }
});
