/*
 * File: app/view/menu/menuPanelViewController.js
 *
 * This file was generated by Sencha Architect version 3.1.0.
 * http://www.sencha.com/products/architect/
 *
 * This file requires use of the Ext JS 5.0.x library, under independent license.
 * License of Sencha Architect does not include license for Ext JS 5.0.x. For more
 * details see http://www.sencha.com/license or contact license@sencha.com.
 *
 * This file will be auto-generated each and everytime you save your project.
 *
 * Do NOT hand edit this file.
 */

Ext.define('Evcorp.view.callcar.rejectEditWinViewController', {
    extend: 'Ext.app.ViewController',
    alias: 'controller.rejectEditWin',
    onProviderSearch : function() {
    	var providerWin = Ext.create({
    		xtype : 'providerListWin',
    		width : '40%',
    		closeAction : 'destroy'
    	});
    	providerWin.show();
    },
	onCreateClaimRule : function() {
		var gridStore = this.getView().getViewModel().getStore('detailGrid');
		var record = gridStore.getAt(0);
		if(record!=null&&record.data.carProductCode!=null&&record.data.quantity!=null&&record.data.unitPrice!=null){
			var accModel = new Evcorp.model.CallCarDemandDetail({
				carProductCode:'',
				id:null
			});
			gridStore.insert(0,accModel);
			var callCarDemandDetailGrid = this.lookupReference('callCarDemandDetailGrid');
			callCarDemandDetailGrid.editingPlugin.startEditByPosition({
		        row: 0,
		        column: 0
		    });
		}else if(record==null){
			var accModel = new Evcorp.model.CallCarDemandDetail({
				carProductCode:''
			});
			gridStore.insert(0,accModel);
			var callCarDemandDetailGrid = this.lookupReference('callCarDemandDetailGrid');
			callCarDemandDetailGrid.editingPlugin.startEditByPosition({
		        row: 0,
		        column: 0
		    });
		}
	},
	saveCallCar:function(){
    	var win = this.getView();
    	var form = this.lookupReference('detailForm');
    	var isValid = form.getForm().isValid();
    	var callCarDemandDetailGrid = this.lookupReference('callCarDemandDetailGrid');
    	var callCarDemandDetailStore = callCarDemandDetailGrid.getStore();
    	var gridData = callCarDemandDetailGrid.getStore().getData().items;
    	var detailItems = [];
    	Ext.each(gridData,function(item){
    		detailItems.push(item.data);
		});
    	var details = JSON.stringify(detailItems);
    	var record = callCarDemandDetailStore.getAt(0);
    	var detailValid = false;
		if(record!=null&&record.data.carProductCode!=null&&record.data.quantity!=null&&record.data.unitPrice!=null)
			detailValid = true;
    	if(isValid&&detailValid){
    		form.submit({
				submitEmptyText:false,
				params:{detailsString:details},
	        	success: function(form, action){
		        	if(action.result.info == 'success'){
		        		Ext.Msg.alert("提示",'提交成功。',function(){
		        			var myActiveTaskGrid = Ext.ComponentQuery.query('#myActiveTaskGrid')[0];
			    			var myActiveTaskStore = myActiveTaskGrid.getStore();
			    			myActiveTaskStore.loadPage(1 ,{"start":0,"limit":20});
			    			var eastPanel = Ext.ComponentQuery.query("#eastPanelId")[0];
			    	        eastPanel.removeAll();
		        			win.close();
		        		});
		        	}
	        	},
				failure: function(){
					Ext.Msg.alert('提示','保存失败。');
				}
	        });
		}else{
			Ext.Msg.alert('提示','表单中存在格式不正确的字段或者空字段');
		}
    },
    onCallCarDemandDetailSelected:function(grid, td, cellIndex, record, tr, rowIndex, e, eOpts){
    	var del = e.getTarget('.btn-danger');
    	var search = e.getTarget('.btn-default');
    	var callCarDemandDetailGrid = this.lookupReference('callCarDemandDetailGrid');
		var callCarDemandDetailStore = callCarDemandDetailGrid.getStore();
    	if(del){
    		if(record.data.demandId!=null){
    			win.mask("请稍等，正在处理中...","x-mask-loading");
    			Ext.Ajax.request({
    				url : 'callCar/deleteCallCarDemandDetail',
    				params : {
    					id : record.data.id
    				},
    	            method: 'POST',	
    				success : function(data) {
    					win.unmask();
    					if(data.responseText=='success'){
    						callCarDemandDetailStore.reload();
    					}
    				}
    			});
    		}else{
    			callCarDemandDetailStore.remove(record);
    		}
    	}
    	if(search){
    		var callCarWin = Ext.create({
    			xtype : 'callCarListWin',
    			closeAction : 'destroy'
    		});
    		callCarWin.show();
    	}
    },
    terminate:function(){
    	var form = this.lookupReference('detailForm');
    	var taskId = form.getForm().getValues().taskId;
    	var processInstanceId = form.getForm().getValues().processInstanceId;
    	var businessKey = form.getForm().getValues().code;
    	var win = this.getView();
    	Ext.Msg.confirm('提示','确定要终止流程吗?',function(btn){
			if(btn=='yes'){
				win.mask("请稍等，正在处理中...","x-mask-loading");
				Ext.Ajax.request({
					url : 'callCar/terminateProcess',
					params : {
						taskId : taskId,
						processInstanceId : processInstanceId,
						businessKey : businessKey
					},
		            method: 'POST',	
					success : function(data) {
						win.unmask();
						if(data.responseText == 'success'){
			        		Ext.Msg.alert("提示",'流程终止成功。',function(){
			        			var myActiveTaskGrid = Ext.ComponentQuery.query('#myActiveTaskGrid')[0];
				    			var myActiveTaskStore = myActiveTaskGrid.getStore();
				    			myActiveTaskStore.loadPage(1 ,{"start":0,"limit":20});
				    			var eastPanel = Ext.ComponentQuery.query("#eastPanelId")[0];
				    	        eastPanel.removeAll();
			        			win.close();
			        		});
			        	}
					}
				});
			}
    	});
    }
});
