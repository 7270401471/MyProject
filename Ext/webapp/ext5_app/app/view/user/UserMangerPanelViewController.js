/*
 * File: app/view/role/RoleMangerPanelViewController.js
 *
 * This file was generated by Sencha Architect version 3.1.0.
 * http://www.sencha.com/products/architect/
 *
 * This file requires use of the Ext JS 5.0.x library, under independent license.
 * License of Sencha Architect does not include license for Ext JS 5.0.x. For more
 * details see http://www.sencha.com/license or contact license@sencha.com.
 *
 * This file will be auto-generated each and everytime you save your project.
 *
 * Do NOT hand edit this file.
 */

Ext.define('Evcorp.view.user.UserMangerPanelViewController', {
    extend: 'Ext.app.ViewController',
    alias: 'controller.usermangerpanelContr',
    
    //添加 用户  
    onAddClick: function (){
        var userGrid = Ext.ComponentQuery.query("viewport usermangerpanel grid")[0];
        var auUserForm = this.lookupReference('auUserForm');
        var userStore = userGrid.getStore(); 
        var rec = new Evcorp.model.AuUser({
        	id:-1,
        	valid: true
        	});
        userStore.insert(0,rec);
        
        userGrid.getSelectionModel().select(rec);
        var username = auUserForm.down("textfield[name=username]");
        username.focus(true, true);	
        //Ext.Msg.alert("提示",'请先选择新建的记录后在右边框录入用户资料');
        /*userStore.sync({
                success: function (e, opts){
                   userStore.reload();
                },
                failure: function (e, opts){
                    Ext.Msg.alert("提示",'请先选择新建的记录后在右边框录入用户资料');
                },
                scope: this
        });*/
    },
    
    onRefreshClick: function(){
        var userGrid = Ext.ComponentQuery.query("viewport usermangerpanel grid")[0];
        var userStore = userGrid.getStore(); 
        userStore.reload(); 
        
    },
    
    onModifyClick: function (){
    	var auUserForm = this.lookupReference('auUserForm');
        //var evcAccountsGrid = this.lookupReference('evcAccountsGrid');
        //alert("KKKK");
    	
    	//var userForm = Ext.ComponentQuery.query("viewport usermangerpanel form")[0];
    	var userId = auUserForm.getForm().getValues().id;
    	console.log("userId____:"+userId);
    	
    	if(!userId){
     	   Ext.Msg.alert("提示",'请先选择或新建一条记录后再编辑用户资料。');
     	   return;
     	}
       //Ext.Msg.alert("提示",'请先选择新建的记录后在右边框录入资料');	
       var userForm = Ext.ComponentQuery.query("viewport usermangerpanel form")[0];
       if(userForm.getForm().isValid()){
    	   userForm.getForm().submit({
               success: function (form, action) {
        	    if(action.result.info=='success'){
            	   Ext.ComponentQuery.query("viewport usermangerpanel grid")[0].getStore().reload();
        	    }else{
        	    	Ext.Msg.alert('提示',action.result.info);
        	    }
    		   }
           });
       }else{
    	   Ext.Msg.alert('提示','必填项不能为空。');
       }
    },
    
    onModifyUserRoleClick: function (){
    	if(this.getView().down('grid').getSelectionModel().getSelection().length == 0){
    		Ext.Msg.alert('提示','请先选中一条记录');
    		return ;
    	}
    	var userWin = Ext.create('Evcorp.view.user.UserRoleWin');
    	var auUserForm = this.lookupReference('auUserForm');
        var userGrid = this.lookupReference('auUserGrid');
    	var userId = auUserForm.getForm().getValues().id;
    	if(userId<0){
    		Ext.Msg.alert('提示','请先保存,再修改');
    		return ;
    	}
    	var roleGrid = Ext.create('Evcorp.view.user.RoleOuGrid',{itemId : 'userRoleOuGrid'});
    	var userRoleOuStore = Ext.create('Evcorp.store.UserRoleOu');
    	userRoleOuStore.load({
    		scope:this,
    		params:{id : userId},
    		callback:function(records){
    			roleGrid.getStore().setData(records);
    			roleGrid.userId = userId;
    			userWin.add(roleGrid);
            	userWin.show();
    		}
    	});
    },
    
    onQueryClick: function (btn){
    	
        var userGrid = Ext.ComponentQuery.query("viewport usermangerpanel grid")[0];
        var name = btn.up('toolbar').down('textfield[name=name]').getValue();
        var userStore = userGrid.getStore(); 
        var extraParams = {username: name};
        userStore.on("beforeload", function (userStore, operation, eOpts) {
					 Ext.apply(userStore.proxy.extraParams, extraParams);
					});
        
        userStore.loadPage(1,{"start":0,"limit":20});
    }
    
});
