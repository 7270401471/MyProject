/*
 * File: app/view/menu/menuPanelViewController.js
 *
 * This file was generated by Sencha Architect version 3.1.0.
 * http://www.sencha.com/products/architect/
 *
 * This file requires use of the Ext JS 5.0.x library, under independent license.
 * License of Sencha Architect does not include license for Ext JS 5.0.x. For more
 * details see http://www.sencha.com/license or contact license@sencha.com.
 *
 * This file will be auto-generated each and everytime you save your project.
 *
 * Do NOT hand edit this file.
 */

Ext.define('Evcorp.view.salesOrder.ContractWinViewController', {
    extend: 'Ext.app.ViewController',
    alias: 'controller.contractWin',
    initWindow:function(){
    	var win = this.getView();
    	var businessKey = win.businessKey; 
    	var businessType = 'attachBizEntityType_XSHT'; // 附件业务实体类型：合同材料代码
    	var businessTypeName = '销售订单材料'; 
		
		var uploadAttachmentPanel = win.down('uploadAttachmentPanel');
		if(uploadAttachmentPanel!=null){
			var attachmentStore = uploadAttachmentPanel.getViewModel().getStore('attachmentStore');
			if(attachmentStore!=null){
				attachmentStore.load({params:{bizEntityCode:businessKey,bizEntityType:businessType}});
			}
			var typeStore = uploadAttachmentPanel.getViewModel().getStore('attachmentTypeStore');
	    	typeStore.load({params:{type:businessType}});
	    	var form = uploadAttachmentPanel.down('form');
	    	if(form!=null){
	    		form.getForm().setValues({businessKey:businessKey,businessType:businessType,businessTypeName:businessTypeName});
	    	}
		}
    },
    saveContract:function(){
    	var form = this.lookupReference('contractForm');
    	var contractNoRef = this.lookupReference('contractNoRef');
    	var isValid = form.getForm().isValid();
		var contractNoText = Ext.ComponentQuery.query('#contractNoItem')[0];
		var contractSignedDateText = Ext.ComponentQuery.query('#contractSignedDateItem')[0];
    	if(isValid){
			Ext.Ajax.request({
				url : 'salesOrder/saveContract',
				params : {
					'saleOrderNo':form.getForm().getValues().saleOrderNo,
					'contractNo':form.getForm().getValues().contractNo,
					'contractSignedDate':form.getForm().getValues().contractSignedDate
				},
	            method: 'POST',	
				success : function(data) {
					if(data.responseText!=null){
						Ext.Msg.alert("提示", '保存成功！');
						contractNoRef.setValue(data.responseText);
						contractNoText.setValue(data.responseText);
						contractSignedDateText.setValue(form.getForm().getValues().contractSignedDate);
					}
				}
			});
    	}
    },
    onDownContractClick:function(){
		var saleOrderNoText=this.lookupReference('saleOrderNoRef');
		var saleOrderNo=saleOrderNoText.getValue();
		window.location.href = 'salesOrder/download/contract?saleOrderNo='
			+ saleOrderNo;
    }
});
